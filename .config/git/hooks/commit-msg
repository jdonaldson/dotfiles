#!/bin/bash
#
# Global commit-msg hook:
# 1. Auto-prefix with issue key from branch name (e.g., DEG-1553)
# 2. Block commits with Claude/AI signatures
#

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# --- Auto-prefix with issue key from branch name ---
branch=$(git branch --show-current 2>/dev/null)
key=$(echo "$branch" | grep -oE '[A-Z]+-[0-9]+' | head -1)

# Add prefix if: key exists, message doesn't have one, and not a merge commit
if [[ -n "$key" ]] && ! [[ "$commit_msg" =~ ^[A-Z]+-[0-9]+ ]] && ! [[ "$commit_msg" =~ ^Merge ]]; then
  echo "$key: $commit_msg" > "$commit_msg_file"
  commit_msg=$(cat "$commit_msg_file")
fi

# Patterns to block
bad_patterns=(
    "Co-Authored-By:.*[Cc]laude"
    "Co-Authored-By:.*[Aa]nthropic"
    "Generated by Claude"
    "Generated by AI"
    "Created by Claude"
)

for pattern in "${bad_patterns[@]}"; do
    if echo "$commit_msg" | grep -qE "$pattern"; then
        echo ""
        echo "❌ COMMIT BLOCKED: Contains Claude/AI signature!"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "Found pattern: $pattern"
        echo ""
        echo "Remove the signature and try again."
        echo ""
        tput bel 2>/dev/null || true
        exit 1
    fi
done

exit 0
